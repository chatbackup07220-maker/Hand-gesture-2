<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Hand Particles</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { margin:0; overflow:hidden; background:black; }
video { display:none; }
#msg {
  position:fixed;
  top:10px;
  left:10px;
  color:white;
  font-family:sans-serif;
  font-size:14px;
}
</style>
</head>

<body>
<div id="msg">Allow camera permission</div>
<video id="video" autoplay playsinline></video>

<!-- THREE JS -->
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

<!-- MEDIAPIPE -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
// ===== THREE SCENE =====
const scene = new THREE.Scene();
const camera3d = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
camera3d.position.z = 60;

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

// ===== PARTICLES =====
const COUNT = 6000;
const geo = new THREE.BufferGeometry();
const pos = new Float32Array(COUNT * 3);
const col = new Float32Array(COUNT * 3);

for(let i=0;i<COUNT*3;i++){
  pos[i]=(Math.random()-0.5)*30;
  col[i]=Math.random();
}

geo.setAttribute("position", new THREE.BufferAttribute(pos,3));
geo.setAttribute("color", new THREE.BufferAttribute(col,3));

const mat = new THREE.PointsMaterial({
  size:0.5,
  vertexColors:true,
  transparent:true,
  blending:THREE.AdditiveBlending
});

const points = new THREE.Points(geo, mat);
scene.add(points);

// ===== HAND DATA =====
let hand = {active:false, dist:0, pinch:false};

// ===== UPDATE =====
function update(){
  const spread = hand.active ? hand.dist*150 : 30;

  for(let i=0;i<COUNT;i++){
    const t=i/COUNT*Math.PI*2;
    pos[i*3]   = Math.sin(t)*spread;
    pos[i*3+1] = Math.cos(t)*spread;
    pos[i*3+2] = Math.sin(t*2)*spread;

    col[i*3]   = hand.pinch ? 1 : 0.3;
    col[i*3+1] = 0.5;
    col[i*3+2] = Math.random();
  }

  geo.attributes.position.needsUpdate=true;
  geo.attributes.color.needsUpdate=true;
}

// ===== HAND TRACKING =====
const hands = new Hands({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});

hands.setOptions({
  maxNumHands:1,
  modelComplexity:1,
  minDetectionConfidence:0.7,
  minTrackingConfidence:0.7
});

hands.onResults(r=>{
  if(!r.multiHandLandmarks){
    hand.active=false;
    return;
  }
  const a=r.multiHandLandmarks[0][4];
  const b=r.multiHandLandmarks[0][8];
  const dx=a.x-b.x, dy=a.y-b.y;
  hand.dist=Math.sqrt(dx*dx+dy*dy);
  hand.pinch=hand.dist<0.03;
  hand.active=true;
});

// ===== CAMERA =====
const cam = new Camera(document.getElementById("video"),{
  onFrame: async()=>await hands.send({image:video}),
  width:640,height:480
});
cam.start();

// ===== LOOP =====
function animate(){
  requestAnimationFrame(animate);
  update();
  renderer.render(scene,camera3d);
}
animate();
</script>

</body>
</html>